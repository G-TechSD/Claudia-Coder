# ============================================
# Supervisor Configuration for Claudia All-in-One
# Manages all services within a single container
# ============================================

[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
logfile_maxbytes=50MB
logfile_backups=3
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

# ============================================
# PostgreSQL Database
# Must start first - other services depend on it
# ============================================
[program:postgresql]
command=/opt/scripts/start-postgresql.sh
user=postgres
autostart=true
autorestart=true
priority=10
startsecs=10
startretries=3
stdout_logfile=/var/log/supervisor/postgresql.log
stderr_logfile=/var/log/supervisor/postgresql-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

# ============================================
# Redis Cache
# ============================================
[program:redis]
command=redis-server --dir %(ENV_REDIS_DIR)s --appendonly yes --maxmemory 256mb --maxmemory-policy allkeys-lru --daemonize no
user=redis
autostart=true
autorestart=true
priority=20
startsecs=5
startretries=3
stdout_logfile=/var/log/supervisor/redis.log
stderr_logfile=/var/log/supervisor/redis-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

# ============================================
# Gitea Git Server
# ============================================
[program:gitea]
command=/opt/scripts/start-gitea.sh
user=git
directory=/data/gitea
autostart=true
autorestart=true
priority=30
startsecs=10
startretries=3
stdout_logfile=/var/log/supervisor/gitea.log
stderr_logfile=/var/log/supervisor/gitea-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
environment=HOME="/data/gitea",USER="git",GITEA_WORK_DIR="/data/gitea"

# ============================================
# n8n Workflow Automation
# Depends on PostgreSQL
# ============================================
[program:n8n]
command=/opt/scripts/start-n8n.sh
user=claudia
autostart=true
autorestart=true
priority=40
startsecs=15
startretries=3
stdout_logfile=/var/log/supervisor/n8n.log
stderr_logfile=/var/log/supervisor/n8n-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

# ============================================
# OpenWebUI Chat Interface
# Connects to Claudia's model router API
# ============================================
[program:openwebui]
command=/opt/scripts/start-openwebui.sh
user=root
autostart=true
autorestart=true
priority=45
startsecs=20
startretries=3
stdout_logfile=/var/log/supervisor/openwebui.log
stderr_logfile=/var/log/supervisor/openwebui-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
environment=DATABASE_URL="postgresql://claudia:claudia_secure_password@localhost:5432/openwebui",OPENAI_API_BASE_URL="http://localhost:3000/api/v1",OPENAI_API_KEY="claudia-internal",ENABLE_OLLAMA_API="false",WEBUI_AUTH="false"

# ============================================
# Ollama Local LLM Server
# Provides local AI model inference
# ============================================
[program:ollama]
command=/opt/scripts/start-ollama.sh
user=root
autostart=true
autorestart=true
priority=35
startsecs=30
startretries=3
stdout_logfile=/var/log/supervisor/ollama.log
stderr_logfile=/var/log/supervisor/ollama-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
environment=OLLAMA_HOST="0.0.0.0",OLLAMA_MODELS="/data/ollama"

# ============================================
# Faster-Whisper Speech-to-Text API
# ============================================
[program:whisper]
command=/opt/scripts/start-whisper.sh
user=root
autostart=true
autorestart=true
priority=50
startsecs=30
startretries=3
stdout_logfile=/var/log/supervisor/whisper.log
stderr_logfile=/var/log/supervisor/whisper-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB

# ============================================
# Claudia Coder (Next.js Application)
# Main application - depends on all other services
# ============================================
[program:claudia]
command=/opt/scripts/start-claudia.sh
user=claudia
directory=/app
autostart=true
autorestart=true
priority=100
startsecs=10
startretries=3
stdout_logfile=/var/log/supervisor/claudia.log
stderr_logfile=/var/log/supervisor/claudia-error.log
stdout_logfile_maxbytes=10MB
stderr_logfile_maxbytes=10MB
environment=NODE_ENV="production",PORT="3000",HOSTNAME="0.0.0.0"

# ============================================
# Service Groups
# ============================================
[group:databases]
programs=postgresql,redis
priority=10

[group:services]
programs=gitea,n8n,openwebui,ollama,whisper
priority=30

[group:apps]
programs=claudia
priority=100
